<html>
        
    <head>
            
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            /* body { font: 13px Helvetica, Arial; } */
            form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
            form input { border: 0; padding: 10px; width: 50%; margin-right: .5%; }
            form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
            #messages { list-style-type: none; margin-bottom: 20px; padding: 0;height: 90%;
                    overflow-y: scroll;overflow-x: hidden; }
            #messages li { padding: 5px 10px; }
            #messages li:nth-child(odd) { background: #eee; }
            #navbar{ background: #2AA54F;height:20px;text-align:center}

            
    aside {
        background-color: cornflowerblue;
        width: /*199px;*/ 250px;
        /* float: right; */
        padding: 20px;
        margin-top: 10px;
        line-height:1.5;
        height: auto;
    }

    address {
        background-color: #D3D3D3;
        width: /*199px;*/ 25%;
        padding: 20px;
        float:right;
        margin-top: 10px;
        line-height:1.5;
    }

    body {
        width: /*1000px;*/ 100%;
        background: /*#5D8AA8;*/ white;
        margin-left: auto;
        margin-right: auto;
        background-color: /*#f0f0f0;*/ white;
        font-family: Helvetica, Arial, sans-serif;
        font-size:15px;
    }

    .container {
        display: flex;
        /* flex-flow: column; */
    }

    main {
	padding: 5px;
	width: 750px; /*100%;*/
    height:250px;
	/* float: left; */

	margin-bottom: 10px;
	margin-top: 10px;
    }

    .playlist {
        background-color: lightskyblue;
        width: /*199px;*/ 750px;
        /*float: right;*/
        padding: 20px;
        margin-top: 10px;
        line-height:1.5;
        height: auto;
    }

    .flex-row {
    flex-direction: row;
    display: flex;
    }

    .flex-column {
        flex-direction: column;
        display: flex;
    }

    .flex-body {
        display: flex;

    }

    .flex-body div:not([class*="flex"]) {
        border: 1px solid white;
        flex: 1 1 300px;
        width: 750px;
        
    }

    </style>
    </head>
    <body>
            <!-- <div class="flex-body">
                    <div class="flex-row">
                      <div style="background: #0980cc;"></div>
                    </div>
                    <div class="flex-column">
                      <div style="background: #09cc69;"></div>
                      <div style="background: #cc092f;"></div>
                    </div>
                  </div> -->

    <div class="flex-body">

        <div class="flex-column">

            <div class="playlist">
                
                <img src="http://megaexplorer.net/websocket/mfjlogo.jpg" width="62" height="62" style="float: left; margin: 8px;">
                <h1>The Multifaceted Jukebox</h1>

                <h4>To satisfy all your emotional needs</h4>

                <object data="http://savethepigs.surge.sh/" allowtransparency="true" width="700" height="300">
                    
                    <!-- <embed src="http://www.web-source.net" width="700" height="300"> </embed>
                    Error: Embedded data could not be displayed. -->
                </object> 

                
            </div>

            <main>

                <nav id='navbar'>Your name is <b><span id="username"></span></b>. Users Online: <span id="numUsers"></span></nav>
                <ul id="messages"></ul>
                <form action="">
                    <input id="m" autocomplete="off" /><button>Send</button>
                </form>

            </main>
 

        </div>

        <div class="flex-row">

            <aside>

                <p>Your URL of photo: </p><input id="input1" type="text" placeholder="Your URL" value="http://www.asamnews.com/wp-content/uploads/2016/11/Trump-Donald6.jpg">
                    
                <button id="button1">Upload</button>

                <p id="myLog"></p>

                <!-- <button onclick="getSpotify()">Retrieve relevant music categories from Spotify</button>  -->
                
                <!-- <button onclick="reset()">Clear Image and Reset</button> -->

                <h1 style="text-decoration: underline">Rooms</h1>
                <ul id="rooms"></ul>

                <h1 style="text-decoration: underline">Online Users</h1>
                <ul id='users'></ul>

                

                <!-- <ul id="room creation"></ul> -->
                <!-- <input id="roomname" style="width:200px;" />
                 <input type="button" id="roombutton" value="create room" /> -->
            
            </aside>


        </div>

    </div>
  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.slim.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script>

        window.console = {
            log: function(str){
                var node = document.createElement("div");
                node.appendChild(document.createTextNode(str));
                document.getElementById("myLog").appendChild(node);
            }
            }

        //Object variable for storing the URL endpoints
		var emotions = {"anger": ["chill", "focus", "karaoke", "rock", "gaming", "metal", "punk"],
						"contempt": ["decades", "travel", "inspirational", "classical"],
						"disgust": ["freshfinds", "comedy", "dinner"],
						"fear": ["j_tracks", "word", "workout"],
						"happiness": ["cantopop", "mandopop", "kpop", "hiphop", "edm_dance", "country", "reggae", "jazz", "popculture"],
						"neutral": ["pop", "cantopop", "mandopop", "country", "reggae", "rnb", "opm", "soul", "indie_alt", "family"],
						"sadness": ["mood", "latin", "folk_americana", "blues", "brazilian", "french_variety", "romance"],
						"surprise": ["party", "kpop", "rock", "karaoke"]
						};

		
		var highest_key; //For storing the emotion with the highest index
	
    $("#button1").click(function() {
        var params = { //Specifies all the JSON data to return (can leave blank)
			"returnFaceId": "true",
            "returnFaceLandmarks": "false",
            "returnFaceAttributes": "age,gender,headPose,smile,facialHair,glasses,emotion,hair,makeup,occlusion,accessories,blur,exposure,noise",
        };

		var pictureURL = document.getElementById("input1").value;

        $.ajax({

            url: "https://westus.api.cognitive.microsoft.com/emotion/v1.0/recognize?" + $.param(params),
            beforeSend: function(xhrObj){

                xhrObj.setRequestHeader("Content-Type","application/json");
                xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key","a9ccd90199684954b1d53482133f0c4a");
            },
            type: "POST",
            // Request body
            //data: '{"url": "https://media.licdn.com/mpr/mpr/shrinknp_200_200/AAEAAQAAAAAAAA2dAAAAJDE0NTY3ZWI5LWRjYzctNGJjMy05MGZlLWE2YWMwODQ4NWQ2Zg.jpg"}',
			data: '{"url": ' + '"' + pictureURL + '"}',
        })
        .done(function(data) {

            //console.log(JSON.stringify(data[0].scores));
            
            reset();

			//Create an 'img' type element and then append it to the HTML
			var img = document.createElement("img");
            img.src = pictureURL;
            img.width = '200';
			var src = document.getElementById("myLog");
			src.appendChild(img);

			var keys = []; //For storing all the emotion keys
			var highest = 0; //For storing the highest index

			//Store all the emotions in "keys" array and find the one with highest index
			$.each(data[0].scores, function(key, value) {
				keys.push(key);
				if (value > highest) {
						highest = value;
					}
			});

			
			//Find the key with the highest index
			$.each(data[0].scores, function(key, value) {
				if (highest == value) {
                    $('#myLog').append('<ul>' + "You have the highest index (" + highest + ") in " + key + "." + '</ul>');
					//console.log("You have the highest index of " + highest + " in " + key + ".");
                     //highest_key = key[0].toUpperCase + key.substring(1);
                   highest_key = key; //Stores the highest key into the global variable for accessing later

                    switchRoom(highest_key);

					//Stopping at the emotion with the highest index to get the corresponding data in the 'emotions' object
					// $.each(emotions, function(key2, value2) {
					// 	if (key == key2) {
					// 		console.log("Since you are in the state of " + key + ", you shall listen to the following music: " + value2);
					// 	}

					// })

				}
			})
		
        })
        .fail(function() {
            alert("error");
        });
    });

        function reset() {
        
            document.getElementById("myLog").innerHTML = "";
            
        }	


        var socket = io();


        socket.on('connect', function() {
                
            //On connection to server, ask for user's name 

                const username = prompt("Please input your username:");
                
                $('#username').html(username);

                //Emits an event 'adduser' and sends the user name to the server
                socket.emit('adduser', username);

        });

        //Listens for the userCount emit events from server and updates the DOM whenever this event is triggered
        socket.on('userCount', function (data) {
                $('#numUsers').html(data.userCount);
            });

        //Whenever the server emits 'updateusers', this updates the username list
        socket.on('updateusers', function(data) {
            $('#users').empty();
            $.each(data, function(key, value) {
                $('#users').append('<ul style="color: lightgreen">' + key + '</ul>');
            });

        });

        //Whenever the server emits 'updatechat', this updates the chatbox
        socket.on('updatechat', function(username, data) {
            $('#messages').append(username + ": " + data + '<br>');
        });


        socket.on('updaterooms', function (rooms, current_room) {
            $('#rooms').empty();
            $.each(rooms, function(key, value) {
                if(value == current_room){
                    $('#rooms').append('<ul>' + value + '</ul>');
                }
                else {
                    $('#rooms').append('<ul><a href="#" onclick="switchRoom(\''+value+'\')">' + value + '</a></ul>');
                }
            });
        });

        function switchRoom(room){
            socket.emit('switchRoom', room);
        }

        $(function () {
        
            //When the user clicks SEND
            $('form').submit(function(){ 
                //Fires off an emit event 'sendchat' to the server
                var message = $('#m').val();
                socket.emit('sendchat', message);
                $('#m').val(''); //clears the input box every time
                
                return false; //prevent reloading of page
            });
            socket.on('sendchat', function(msg){
                //Listens out for the server broadcast and renders the message to the user
                $('#messages').append($('<li>').text(`${msg.username} : ${msg.message} \n`));
            }); 

            // $('#roombutton').click(function(){
            //     var name = $('#roomname').val();
            //     $('#roomname').val('');
            //     socket.emit('create', name)
            // });

        
        });



        // Detect typing

// function timeoutFunction() {  
//     typing = false;
//     socket.emit("typing", false);
//     socket.emit("notTyping", true)
//   }

//   $("#msg").keypress(function(e){
//     if (e.which !== 13) {
//       if (typing === false && $("#msg").is(":focus")) {
//       typing = true;
//       socket.emit("typing", true);
//       } else {
//           clearTimeout(timeout);
//           timeout = setTimeout(timeoutFunction, 1500);
//         }
//     }
//     else if(e.which == 13 && $("#msg").val() !== "") {
//       $("#"+data.person+"").remove();
//     }
//   });

//   socket.on("isTyping", function(data) {  
//     if (data.isTyping) {
//       if ($("#"+data.person+"").length === 0) {
//         socket.emit("checkTypingFunction");
//         $("#chat").append("<div id='"+ data.person +"'><span class='grey'>" + data.person + " is typing...</div>");
//         timeout = setTimeout(timeoutFunction, 1500);
//       }
//     } else {
//        $("#"+data.person+"").remove();
//       }
//   });
    </script>
    
    </body>
</html>
    